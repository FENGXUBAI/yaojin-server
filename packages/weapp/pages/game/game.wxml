<!--pages/game/game.wxml - æ¸¸æˆä¸»ç•Œé¢-->
<view class="game-table">
  <!-- å¯¹æ‰‹ç©å®¶ (ä¸Šæ–¹) -->
  <view class="player-area player-top" wx:if="{{opponents[0]}}">
    <view class="player-info">
      <image class="avatar avatar-small" src="{{opponents[0].avatar || '/images/default-avatar.png'}}" />
      <text class="player-name">{{opponents[0].name}}</text>
      <text class="card-count">{{opponents[0].cardCount}}å¼ </text>
    </view>
    <!-- å‡ºçš„ç‰Œ -->
    <view class="played-cards" wx:if="{{opponents[0].lastPlay}}">
      <view class="card card-small {{card.isRed ? 'card-red' : 'card-black'}}" 
            wx:for="{{opponents[0].lastPlay}}" wx:key="index">
        <text class="card-rank">{{card.rank}}</text>
        <text class="card-suit">{{card.suit}}</text>
      </view>
    </view>
    <text class="pass-text" wx:if="{{opponents[0].passed}}">ä¸è¦</text>
  </view>

  <!-- å·¦è¾¹å¯¹æ‰‹ -->
  <view class="player-area player-left" wx:if="{{opponents[1]}}">
    <view class="player-info">
      <image class="avatar avatar-small" src="{{opponents[1].avatar || '/images/default-avatar.png'}}" />
      <text class="player-name">{{opponents[1].name}}</text>
      <text class="card-count">{{opponents[1].cardCount}}å¼ </text>
    </view>
    <view class="played-cards" wx:if="{{opponents[1].lastPlay}}">
      <view class="card card-small" wx:for="{{opponents[1].lastPlay}}" wx:key="index">
        <text class="card-rank">{{card.rank}}</text>
      </view>
    </view>
    <text class="pass-text" wx:if="{{opponents[1].passed}}">ä¸è¦</text>
  </view>

  <!-- å³è¾¹å¯¹æ‰‹ -->
  <view class="player-area player-right" wx:if="{{opponents[2]}}">
    <view class="player-info">
      <image class="avatar avatar-small" src="{{opponents[2].avatar || '/images/default-avatar.png'}}" />
      <text class="player-name">{{opponents[2].name}}</text>
      <text class="card-count">{{opponents[2].cardCount}}å¼ </text>
    </view>
    <view class="played-cards" wx:if="{{opponents[2].lastPlay}}">
      <view class="card card-small" wx:for="{{opponents[2].lastPlay}}" wx:key="index">
        <text class="card-rank">{{card.rank}}</text>
      </view>
    </view>
    <text class="pass-text" wx:if="{{opponents[2].passed}}">ä¸è¦</text>
  </view>

  <!-- ä¸­å¤®å‡ºç‰ŒåŒºåŸŸ -->
  <view class="play-area">
    <view class="played-cards" wx:if="{{centerCards.length > 0}}">
      <view class="card {{card.isRed ? 'card-red' : 'card-black'}}" 
            wx:for="{{centerCards}}" wx:key="index"
            style="margin-left: {{index > 0 ? '-30rpx' : '0'}}">
        <text class="card-rank">{{card.displayRank}}</text>
        <text class="card-suit">{{card.suit}}</text>
      </view>
    </view>
    <text class="play-label" wx:if="{{playLabel}}">{{playLabel}}</text>
  </view>

  <!-- ç‚¸å¼¹ç‰¹æ•ˆ -->
  <view class="bomb-effect {{showBombEffect ? 'active' : ''}}" wx:if="{{showBombEffect}}">
    <text class="bomb-text">{{bombText}}</text>
  </view>

  <!-- åº•éƒ¨è‡ªå·±åŒºåŸŸ -->
  <view class="player-area player-bottom">
    <!-- æˆ‘çš„å¤´åƒå’Œä¿¡æ¯ -->
    <view class="my-info">
      <image class="avatar" src="{{myInfo.avatar || '/images/default-avatar.png'}}" />
      <view class="my-details">
        <text class="my-name">{{myInfo.name}}</text>
        <text class="my-score">é‡‘å¸: {{myInfo.coins}}</text>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-bar" wx:if="{{isMyTurn}}">
      <view class="btn btn-danger" bindtap="handlePass">
        <text>{{passCountdown > 0 ? 'ä¸è¦(' + passCountdown + ')' : 'ä¸è¦'}}</text>
      </view>
      <view class="btn btn-warning" bindtap="handleHint">
        <text>æç¤º</text>
      </view>
      <view class="btn btn-success" bindtap="handlePlay">
        <text>å‡ºç‰Œ</text>
      </view>
      <view class="btn {{autoPlay ? 'btn-secondary' : 'btn-primary'}}" bindtap="toggleAutoPlay">
        <text>{{autoPlay ? 'å–æ¶ˆæ‰˜ç®¡' : 'æ‰˜ç®¡'}}</text>
      </view>
    </view>

    <!-- å€’è®¡æ—¶æç¤º -->
    <view class="timer-hint" wx:if="{{isMyTurn}}">
      <text class="timer-text">{{cannotPlay ? 'æ— ç‰Œå¯å‡º' : timeLeft + 's'}}</text>
    </view>

    <!-- æ‰‹ç‰ŒåŒºåŸŸ -->
    <scroll-view class="hand-area" scroll-x="true">
      <view class="hand-cards">
        <view class="card hand-card {{selectedCards[index] ? 'card-selected' : ''}} {{card.isRed ? 'card-red' : 'card-black'}}"
              wx:for="{{myCards}}" 
              wx:key="index"
              bindtap="toggleCard"
              data-index="{{index}}">
          <text class="card-rank">{{card.displayRank}}</text>
          <text class="card-suit">{{card.suit}}</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æˆ¿é—´ä¿¡æ¯ -->
  <view class="room-info">
    <text>æˆ¿é—´: {{roomId}} | å€æ•°: x{{multiplier}}</text>
  </view>

  <!-- èŠå¤©æŒ‰é’® -->
  <view class="chat-btn" bindtap="toggleChat">
    <text>ğŸ’¬</text>
  </view>

  <!-- èŠå¤©é¢æ¿ -->
  <view class="chat-panel {{showChat ? 'active' : ''}}" wx:if="{{showChat}}">
    <view class="chat-close" bindtap="toggleChat">Ã—</view>
    <scroll-view class="chat-messages" scroll-y="true" scroll-into-view="{{lastMsgId}}">
      <view class="chat-msg" wx:for="{{chatMessages}}" wx:key="index" id="msg-{{index}}">
        <text class="chat-sender">{{item.player}}:</text>
        <text class="chat-content">{{item.message}}</text>
      </view>
    </scroll-view>
    
    <!-- å¿«æ·è¡¨æƒ… -->
    <view class="emoji-picker">
      <text class="emoji-item" wx:for="{{emojis}}" wx:key="*this" bindtap="sendEmoji" data-emoji="{{item}}">{{item}}</text>
    </view>
    
    <!-- å¿«æ·çŸ­è¯­ -->
    <view class="quick-phrases">
      <text class="quick-phrase" wx:for="{{quickPhrases}}" wx:key="*this" bindtap="sendPhrase" data-phrase="{{item}}">{{item}}</text>
    </view>
    
    <!-- è¾“å…¥æ¡† -->
    <view class="chat-input-area">
      <input class="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." value="{{chatInput}}" bindinput="onChatInput" bindconfirm="sendChat"/>
      <view class="btn btn-primary btn-small" bindtap="sendChat">å‘é€</view>
    </view>
  </view>

  <!-- æ¸¸æˆç»“æŸå¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showGameOver}}">
    <view class="modal-content">
      <text class="modal-title">æ¸¸æˆç»“æŸ</text>
      <view class="score-list">
        <view class="score-item" wx:for="{{finalScores}}" wx:key="index">
          <text class="score-name">{{item.name}}</text>
          <text class="score-value {{item.score >= 0 ? 'win' : 'lose'}}">{{item.score >= 0 ? '+' : ''}}{{item.score}}</text>
        </view>
      </view>
      <view class="modal-actions">
        <view class="btn btn-primary" bindtap="playAgain" wx:if="{{isOwner}}">å†æ¥ä¸€å±€</view>
        <view class="btn btn-warning" bindtap="backToLobby">è¿”å›å¤§å…</view>
      </view>
    </view>
  </view>
</view>
