<!--pages/game/game.wxml - è¦è¿›æ¸¸æˆä¸»ç•Œé¢ (ç¾åŒ–ç‰ˆ)-->
<view class="game-container">
  <!-- èƒŒæ™¯è£…é¥° -->
  <view class="bg-decoration">
    <view class="bg-pattern"></view>
    <view class="bg-glow"></view>
  </view>

  <!-- æ¸¸æˆæ¡Œé¢ -->
  <view class="game-table">
    <!-- æ¡Œé¢çº¹ç† -->
    <view class="table-felt"></view>
    <view class="table-border"></view>
    
    <!-- æˆ¿é—´ä¿¡æ¯æ  -->
    <view class="room-header">
      <view class="room-info-left">
        <text class="room-label">æˆ¿é—´</text>
        <text class="room-id">{{roomId}}</text>
      </view>
      <view class="room-info-center">
        <view class="multiplier-badge {{multiplier > 1 ? 'multiplier-active' : ''}}">
          <text class="multiplier-icon">ğŸ”¥</text>
          <text class="multiplier-value">x{{multiplier}}</text>
        </view>
      </view>
      <view class="room-info-right">
        <view class="menu-btn" bindtap="showMenu">
          <text class="menu-icon">âš™ï¸</text>
        </view>
      </view>
    </view>

    <!-- å¯¹æ‰‹ç©å®¶åŒºåŸŸ - ä¸Šæ–¹ -->
    <view class="opponent-area opponent-top {{currentTurn === opponents[0].index ? 'is-turn' : ''}} {{opponents[0].finished ? 'is-finished' : ''}}" wx:if="{{opponents[0]}}">
      <view class="player-panel">
        <view class="player-avatar-wrap">
          <view class="avatar avatar-sm avatar-placeholder" wx:if="{{!opponents[0].avatar}}">
            <text>{{opponents[0].name[0] || '?'}}</text>
          </view>
          <image class="avatar avatar-sm" src="{{opponents[0].avatar}}" mode="aspectFill" wx:if="{{opponents[0].avatar}}" />
          <view class="turn-indicator" wx:if="{{currentTurn === opponents[0].index}}"></view>
          <view class="rank-badge" wx:if="{{opponents[0].finishRank}}">
            <text>{{opponents[0].finishRank}}</text>
          </view>
        </view>
        <view class="player-details">
          <text class="player-name">{{opponents[0].name}}</text>
          <view class="card-count-badge">
            <text class="card-icon">ğŸƒ</text>
            <text class="card-num">{{opponents[0].cardCount}}</text>
          </view>
        </view>
      </view>
      <!-- å¯¹æ‰‹å‡ºçš„ç‰Œ -->
      <view class="opponent-played" wx:if="{{opponents[0].lastPlay && opponents[0].lastPlay.length > 0}}">
        <view class="played-cards-row animate-slide-down">
          <view class="poker-card poker-card-sm {{getCardColorClass(card)}}" 
                wx:for="{{opponents[0].lastPlay}}" wx:key="index"
                style="margin-left: {{index > 0 ? '-20rpx' : '0'}}">
            <text class="card-rank">{{card.displayRank}}</text>
            <text class="card-suit">{{card.suit}}</text>
          </view>
        </view>
      </view>
      <view class="pass-indicator animate-fade-in" wx:if="{{opponents[0].passed}}">
        <text>è¿‡</text>
      </view>
    </view>

    <!-- å¯¹æ‰‹ç©å®¶åŒºåŸŸ - å·¦è¾¹ -->
    <view class="opponent-area opponent-left {{currentTurn === opponents[1].index ? 'is-turn' : ''}} {{opponents[1].finished ? 'is-finished' : ''}}" wx:if="{{opponents[1]}}">
      <view class="player-panel player-panel-vertical">
        <view class="player-avatar-wrap">
          <view class="avatar avatar-sm avatar-placeholder" wx:if="{{!opponents[1].avatar}}">
            <text>{{opponents[1].name[0] || '?'}}</text>
          </view>
          <image class="avatar avatar-sm" src="{{opponents[1].avatar}}" mode="aspectFill" wx:if="{{opponents[1].avatar}}" />
          <view class="turn-indicator" wx:if="{{currentTurn === opponents[1].index}}"></view>
          <view class="rank-badge" wx:if="{{opponents[1].finishRank}}">
            <text>{{opponents[1].finishRank}}</text>
          </view>
        </view>
        <text class="player-name">{{opponents[1].name}}</text>
        <view class="card-count-badge">
          <text class="card-icon">ğŸƒ</text>
          <text class="card-num">{{opponents[1].cardCount}}</text>
        </view>
      </view>
      <view class="opponent-played opponent-played-left" wx:if="{{opponents[1].lastPlay && opponents[1].lastPlay.length > 0}}">
        <view class="played-cards-col animate-slide-right">
          <view class="poker-card poker-card-sm {{getCardColorClass(card)}}" 
                wx:for="{{opponents[1].lastPlay}}" wx:key="index"
                style="margin-top: {{index > 0 ? '-60rpx' : '0'}}">
            <text class="card-rank">{{card.displayRank}}</text>
            <text class="card-suit">{{card.suit}}</text>
          </view>
        </view>
      </view>
      <view class="pass-indicator animate-fade-in" wx:if="{{opponents[1].passed}}">
        <text>è¿‡</text>
      </view>
    </view>

    <!-- å¯¹æ‰‹ç©å®¶åŒºåŸŸ - å³è¾¹ -->
    <view class="opponent-area opponent-right {{currentTurn === opponents[2].index ? 'is-turn' : ''}} {{opponents[2].finished ? 'is-finished' : ''}}" wx:if="{{opponents[2]}}">
      <view class="player-panel player-panel-vertical">
        <view class="player-avatar-wrap">
          <view class="avatar avatar-sm avatar-placeholder" wx:if="{{!opponents[2].avatar}}">
            <text>{{opponents[2].name[0] || '?'}}</text>
          </view>
          <image class="avatar avatar-sm" src="{{opponents[2].avatar}}" mode="aspectFill" wx:if="{{opponents[2].avatar}}" />
          <view class="turn-indicator" wx:if="{{currentTurn === opponents[2].index}}"></view>
          <view class="rank-badge" wx:if="{{opponents[2].finishRank}}">
            <text>{{opponents[2].finishRank}}</text>
          </view>
        </view>
        <text class="player-name">{{opponents[2].name}}</text>
        <view class="card-count-badge">
          <text class="card-icon">ğŸƒ</text>
          <text class="card-num">{{opponents[2].cardCount}}</text>
        </view>
      </view>
      <view class="opponent-played opponent-played-right" wx:if="{{opponents[2].lastPlay && opponents[2].lastPlay.length > 0}}">
        <view class="played-cards-col animate-slide-left">
          <view class="poker-card poker-card-sm {{getCardColorClass(card)}}" 
                wx:for="{{opponents[2].lastPlay}}" wx:key="index"
                style="margin-top: {{index > 0 ? '-60rpx' : '0'}}">
            <text class="card-rank">{{card.displayRank}}</text>
            <text class="card-suit">{{card.suit}}</text>
          </view>
        </view>
      </view>
      <view class="pass-indicator animate-fade-in" wx:if="{{opponents[2].passed}}">
        <text>è¿‡</text>
      </view>
    </view>

    <!-- ä¸­å¤®å‡ºç‰ŒåŒºåŸŸ -->
    <view class="center-play-area">
      <view class="center-cards-wrapper" wx:if="{{centerCards.length > 0}}">
        <view class="center-cards animate-card-play">
          <view class="poker-card {{getCardColorClass(card)}}" 
                wx:for="{{centerCards}}" wx:key="index"
                style="margin-left: {{index > 0 ? '-35rpx' : '0'}}; transform: rotate({{(index - centerCards.length/2) * 2}}deg)">
            <text class="card-rank">{{card.displayRank}}</text>
            <text class="card-suit">{{card.suit}}</text>
          </view>
        </view>
        <view class="play-type-label" wx:if="{{playLabel}}">
          <text>{{playLabel}}</text>
        </view>
      </view>
      
      <!-- ç‰Œæ¡Œä¸­å¿ƒLOGO -->
      <view class="table-logo" wx:if="{{!centerCards.length && !showBombEffect}}">
        <text class="logo-text">è¦è¿›</text>
        <text class="logo-sub">YAOJIN</text>
      </view>
    </view>

    <!-- ç‰¹æ•ˆå±‚ -->
    <view class="effects-layer">
      <!-- ç‚¸å¼¹ç‰¹æ•ˆ -->
      <view class="bomb-effect {{bombEffectType}}" wx:if="{{showBombEffect}}">
        <view class="bomb-animation">
          <text class="bomb-text">{{bombText}}</text>
          <view class="bomb-particles">
            <view class="particle" wx:for="{{12}}" wx:key="index"></view>
          </view>
        </view>
      </view>
      
      <!-- æ¥é£ç‰¹æ•ˆ -->
      <view class="jiefeng-effect" wx:if="{{showJiefengEffect}}">
        <text class="jiefeng-text">æ¥é£!</text>
      </view>
      
      <!-- èµ·ç‚¸ç‰¹æ•ˆ -->
      <view class="qizha-effect" wx:if="{{showQizhaEffect}}">
        <text class="qizha-text">èµ·!</text>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨ç©å®¶åŒºåŸŸ -->
  <view class="player-bottom-area">
    <!-- ç©å®¶ä¿¡æ¯æ¡ -->
    <view class="my-player-bar">
      <view class="my-info-section">
        <view class="my-avatar-wrap">
          <view class="avatar avatar-placeholder" wx:if="{{!myInfo.avatar}}">
            <text>{{myInfo.name[0] || 'æˆ‘'}}</text>
          </view>
          <image class="avatar" src="{{myInfo.avatar}}" mode="aspectFill" wx:if="{{myInfo.avatar}}" />
          <view class="my-level">Lv.{{myInfo.level || 1}}</view>
        </view>
        <view class="my-details">
          <text class="my-name">{{myInfo.name}}</text>
          <view class="my-coins">
            <text class="coins-icon">ğŸ’°</text>
            <text class="coins-value">{{myInfo.coins}}</text>
          </view>
        </view>
      </view>
      
      <!-- å‡ºç‰Œå€’è®¡æ—¶ -->
      <view class="timer-section {{isMyTurn ? 'timer-active' : ''}}" wx:if="{{isMyTurn}}">
        <view class="timer-ring">
          <view class="timer-progress" style="--progress: {{(timeLeft/30) * 100}}%"></view>
          <text class="timer-text">{{timeLeft}}</text>
        </view>
        <text class="timer-label">{{cannotPlay ? 'æ— ç‰Œå¯å‡º' : 'è½®åˆ°ä½ äº†'}}</text>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’®åŒº -->
    <view class="action-buttons {{isMyTurn ? 'actions-active' : 'actions-disabled'}}">
      <view class="btn btn-danger action-btn" bindtap="handlePass" wx:if="{{canPass}}">
        <text class="btn-icon">âœ–</text>
        <text class="btn-label">ä¸è¦</text>
      </view>
      <view class="btn btn-warning action-btn" bindtap="handleHint">
        <text class="btn-icon">ğŸ’¡</text>
        <text class="btn-label">æç¤º</text>
      </view>
      <view class="btn btn-success action-btn {{selectedCards.length === 0 ? 'btn-disabled' : ''}}" bindtap="handlePlay">
        <text class="btn-icon">âœ“</text>
        <text class="btn-label">å‡ºç‰Œ</text>
      </view>
      <view class="btn {{autoPlay ? 'btn-secondary' : 'btn-ghost'}} action-btn" bindtap="toggleAutoPlay">
        <text class="btn-icon">ğŸ¤–</text>
        <text class="btn-label">{{autoPlay ? 'æ‰˜ç®¡ä¸­' : 'æ‰˜ç®¡'}}</text>
      </view>
    </view>

    <!-- æ‰‹ç‰ŒåŒºåŸŸ -->
    <view class="hand-section">
      <scroll-view class="hand-scroll" scroll-x="true" enhanced="true" show-scrollbar="false">
        <view class="hand-cards">
          <view class="poker-card hand-card {{selectedCards[index] ? 'poker-card-selected' : ''}} {{getCardColorClass(card)}} {{card.isTribute ? 'card-tribute' : ''}}"
                wx:for="{{myCards}}" 
                wx:key="index"
                bindtap="toggleCard"
                data-index="{{index}}"
                style="margin-left: {{index > 0 ? '-35rpx' : '0'}}; animation-delay: {{index * 0.03}}s">
            <text class="card-rank">{{card.displayRank}}</text>
            <text class="card-suit">{{card.suit}}</text>
            <view class="tribute-mark" wx:if="{{card.isTribute}}">è´¡</view>
          </view>
        </view>
      </scroll-view>
      <view class="hand-count">
        <text>{{myCards.length}}å¼ </text>
      </view>
    </view>
  </view>

  <!-- èŠå¤©å…¥å£ -->
  <view class="chat-fab" bindtap="toggleChat">
    <text class="chat-icon">ğŸ’¬</text>
    <view class="chat-badge" wx:if="{{unreadMessages > 0}}">{{unreadMessages}}</view>
  </view>

  <!-- å¿«æ·èŠå¤©é¢æ¿ -->
  <view class="quick-chat-panel {{showQuickChat ? 'show' : ''}}" wx:if="{{showQuickChat}}">
    <view class="quick-chat-header">
      <text class="quick-chat-title">å¿«æ·èŠå¤©</text>
      <view class="quick-chat-close" bindtap="toggleChat">Ã—</view>
    </view>
    
    <view class="emoji-grid">
      <view class="emoji-item" wx:for="{{emojis}}" wx:key="*this" bindtap="sendEmoji" data-emoji="{{item}}">
        <text>{{item}}</text>
      </view>
    </view>
    
    <view class="divider"></view>
    
    <view class="phrase-list">
      <view class="phrase-item" wx:for="{{quickPhrases}}" wx:key="*this" bindtap="sendPhrase" data-phrase="{{item}}">
        <text>{{item}}</text>
      </view>
    </view>
  </view>

  <!-- èœå•å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showMenu}}" bindtap="hideMenu">
    <view class="modal-content menu-modal" catchtap="">
      <text class="modal-title">æ¸¸æˆèœå•</text>
      
      <view class="menu-options">
        <view class="menu-item" bindtap="toggleSound">
          <text class="menu-icon">{{soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡'}}</text>
          <text class="menu-label">{{soundEnabled ? 'å…³é—­éŸ³æ•ˆ' : 'å¼€å¯éŸ³æ•ˆ'}}</text>
        </view>
        <view class="menu-item" bindtap="toggleMusic">
          <text class="menu-icon">{{musicEnabled ? 'ğŸµ' : 'ğŸµ'}}</text>
          <text class="menu-label">{{musicEnabled ? 'å…³é—­éŸ³ä¹' : 'å¼€å¯éŸ³ä¹'}}</text>
        </view>
        <view class="menu-item" bindtap="viewRules">
          <text class="menu-icon">ğŸ“–</text>
          <text class="menu-label">æ¸¸æˆè§„åˆ™</text>
        </view>
        <view class="menu-item menu-item-danger" bindtap="leaveGame">
          <text class="menu-icon">ğŸšª</text>
          <text class="menu-label">é€€å‡ºæ¸¸æˆ</text>
        </view>
      </view>
      
      <view class="btn btn-ghost btn-block mt-lg" bindtap="hideMenu">
        <text>è¿”å›æ¸¸æˆ</text>
      </view>
    </view>
  </view>

  <!-- è¿›è´¡/å›è´¡å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showTributeModal}}">
    <view class="modal-content tribute-modal">
      <text class="modal-title">{{tributeType === 'give' ? 'è¿›è´¡' : 'å›è´¡'}}</text>
      <text class="tribute-desc">{{tributeDescription}}</text>
      
      <view class="tribute-cards">
        <view class="poker-card {{getCardColorClass(card)}} {{selectedTributeCards[index] ? 'poker-card-selected' : ''}}"
              wx:for="{{tributeCards}}" wx:key="index"
              bindtap="toggleTributeCard" data-index="{{index}}">
          <text class="card-rank">{{card.displayRank}}</text>
          <text class="card-suit">{{card.suit}}</text>
        </view>
      </view>
      
      <view class="btn btn-primary btn-block mt-lg" bindtap="confirmTribute">
        <text>ç¡®è®¤{{tributeType === 'give' ? 'è¿›è´¡' : 'å›è´¡'}}</text>
      </view>
    </view>
  </view>

  <!-- æ¸¸æˆç»“æŸå¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showGameOver}}">
    <view class="modal-content game-over-modal">
      <view class="result-header {{myRank <= 2 ? 'result-win' : 'result-lose'}}">
        <text class="result-icon">{{myRank === 1 ? 'ğŸ†' : myRank === 2 ? 'ğŸ¥ˆ' : myRank === 3 ? 'ğŸ¥‰' : 'ğŸ˜¢'}}</text>
        <text class="result-title">{{myRank === 1 ? 'å¤´æ¸¸!' : myRank === 2 ? 'äºŒæ¸¸!' : myRank === 3 ? 'ä¸‰æ¸¸' : 'æœ«æ¸¸'}}</text>
      </view>
      
      <view class="score-change {{scoreChange >= 0 ? 'score-win' : 'score-lose'}}">
        <text>{{scoreChange >= 0 ? '+' : ''}}{{scoreChange}}</text>
        <text class="score-label">é‡‘å¸</text>
      </view>
      
      <view class="final-rankings">
        <view class="ranking-item" wx:for="{{finalRankings}}" wx:key="index">
          <view class="ranking-pos">
            <text>{{index + 1}}</text>
          </view>
          <view class="ranking-player">
            <view class="avatar avatar-sm avatar-placeholder">
              <text>{{item.name[0]}}</text>
            </view>
            <text class="ranking-name">{{item.name}}</text>
          </view>
          <text class="ranking-score {{item.score >= 0 ? 'text-success' : 'text-danger'}}">
            {{item.score >= 0 ? '+' : ''}}{{item.score}}
          </text>
        </view>
      </view>
      
      <view class="game-over-actions">
        <view class="btn btn-primary btn-lg" bindtap="playAgain" wx:if="{{canPlayAgain}}">
          <text>ğŸ”„ å†æ¥ä¸€å±€</text>
        </view>
        <view class="btn btn-ghost btn-lg" bindtap="backToLobby">
          <text>ğŸ  è¿”å›å¤§å…</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç­‰å¾…å…¶ä»–ç©å®¶å¼¹çª— -->
  <view class="waiting-overlay" wx:if="{{isWaiting}}">
    <view class="waiting-content">
      <view class="waiting-spinner">
        <view class="loading-spinner"></view>
      </view>
      <text class="waiting-text">{{waitingMessage}}</text>
      <view class="waiting-players">
        <view class="waiting-player {{item.ready ? 'ready' : ''}}" wx:for="{{waitingPlayers}}" wx:key="index">
          <view class="avatar avatar-sm avatar-placeholder">
            <text>{{item.name[0] || '?'}}</text>
          </view>
          <text class="waiting-name">{{item.name || 'ç­‰å¾…åŠ å…¥...'}}</text>
          <text class="ready-icon" wx:if="{{item.ready}}">âœ“</text>
        </view>
      </view>
      <view class="btn btn-danger mt-lg" bindtap="cancelWaiting" wx:if="{{canCancelWaiting}}">
        <text>å–æ¶ˆ</text>
      </view>
    </view>
  </view>
</view>
